# 08-overlaps-shims-wip

## Overlap / shim / WIP matrix

| Area | Overlap / shim | Locations | Used by (evidence) |
|---|---|---|---|
| Subject naming | Two subject schemes: `greentic.messaging.ingress/egress` (gateway/egress) vs `greentic.msg.in/out` (runner/legacy). | `crates/gsm-bus/src/lib.rs`, `libs/core/src/subjects.rs`. | Gateway uses `ingress_subject_with_prefix`; runner/legacy use `in_subject`/`out_subject`. (Evidence: `apps/messaging-gateway/src/http.rs:35-43`; `apps/runner/src/main.rs:37-176`; `docs/audit/_evidence/rg/envelopes.txt`)
| Envelope variants | `MessageEnvelope` vs `ChannelMessage` vs provider `ChannelMessageEnvelope` alias. | `libs/core/src/types.rs`, `libs/core/src/provider_ops.rs`. | Gateway publishes `ChannelMessage`, runner uses `MessageEnvelope`, provider ops expect `ChannelMessageEnvelope`. (Evidence: `apps/messaging-gateway/src/http.rs:248-275`; `libs/core/src/types.rs:12-199`; `docs/audit/_evidence/rg/envelopes.txt`)
| Idempotency | Two implementations: `gsm_core::SeenSet` (local) and `gsm_idempotency` JetStream KV. | `libs/core/src/idempotency.rs`, `libs/idempotency/src/lib.rs`. | Legacy ingress uses `gsm_idempotency::IdempotencyGuard`; `SeenSet` exists as a local helper. (Evidence: `legacy/apps/ingress-telegram/src/main.rs:548-575`; `libs/core/src/idempotency.rs:1-80`; `docs/audit/_evidence/rg/state_store.txt`)
| Provider abstraction | Multiple provider interfaces: `ProviderRegistry` (core), `PlatformProvider`, and `gsm-provider-registry` send/receive adapters. | `libs/core/src/registry.rs`, `libs/core/src/platforms/provider.rs`, `libs/gsm-provider-registry/src/registry.rs`. | Legacy ingress uses `ProviderRegistry`; pack/registry uses `gsm-provider-registry`; webchat uses `PlatformProvider`. (Evidence: `legacy/apps/ingress-telegram/src/main.rs:627-639`; `libs/gsm-provider-registry/src/registry.rs:53-107`; `docs/audit/_evidence/rg/providers.txt`)
| Legacy apps vs new services | Legacy ingress/egress binaries coexist with new gateway/egress services. | `legacy/apps/*`, `apps/messaging-gateway`, `apps/messaging-egress`. | CLI can run new services; legacy apps are still present and referenced in docs/scripts. (Evidence: `apps/messaging-gateway/src/main.rs:6-12`; `legacy/apps/ingress-telegram/src/main.rs:447-608`; `docs/audit/_evidence/rg/overlaps_wip.txt`)
| Legacy renderer fallback | Legacy egress apps fall back to legacy payloads when adaptive render fails. | `legacy/apps/egress-webchat/src/main.rs`, `legacy/apps/egress-teams/src/main.rs`. | `warn!` log indicates fallback to legacy translator/payload. (Evidence: `legacy/apps/egress-webchat/src/main.rs:333-349`; `legacy/apps/egress-teams/src/main.rs:219-233`; `docs/audit/_evidence/rg/overlaps_wip.txt`)
| Pack compatibility shim | Adapter registry reloads `manifest.cbor` to recover provider extensions while keeping legacy adapters. | `libs/core/src/adapter_registry.rs`. | Used when loading `.gtpack` for adapter/extension compatibility. (Evidence: `libs/core/src/adapter_registry.rs:158-188`; `docs/audit/_evidence/rg/overlaps_wip.txt`)
| Secrets migration | Env/`SECRETS_ROOT` fallbacks still supported alongside `greentic-secrets` seeds. | `libs/testutil/src/lib.rs`, provider docs. | Warnings emitted when legacy env/SECRETS_ROOT used. (Evidence: `libs/testutil/src/lib.rs:68-118`; `docs/audit/_evidence/rg/secrets.txt`)
| WIP provider implementation | WebChat `send_card`/`verify_webhook` are `bail!` stubs. | `libs/core/src/platforms/webchat/provider.rs`. | Explicit not implemented errors. (Evidence: `libs/core/src/platforms/webchat/provider.rs:119-150`; `docs/audit/_evidence/rg/overlaps_wip.txt`)
| WIP flows | Pack README notes placeholder flows under `flows/messaging/...` not yet present. | `packs/messaging/README.md`. | Flow placeholders called out as not present. (Evidence: `packs/messaging/README.md:1-4`; `docs/audit/_evidence/rg/overlaps_wip.txt`)
| CLI legacy helpers | CLI exposes legacy setup scripts (teams/telegram/whatsapp). | `crates/greentic-messaging-cli/src/main.rs`. | CLI runs `legacy/scripts/...` helpers. (Evidence: `crates/greentic-messaging-cli/src/main.rs:879-889`; `docs/audit/_evidence/rg/overlaps_wip.txt`)

## Known Unknowns

- Legacy apps under `legacy/` may not be exercised by current workflows; usage in production is not observable from this repo alone. (Evidence: `legacy/Cargo.toml:1`; `docs/audit/_evidence/rg/overlaps_wip.txt`)
