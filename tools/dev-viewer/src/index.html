<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Greentic Dev Viewer</title>
    <style>
      :root {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #101828;
        background: #f5f5f5;
      }

      body {
        margin: 0;
        padding: 0;
        display: flex;
        min-height: 100vh;
      }

      aside {
        width: 320px;
        background: #ffffff;
        border-right: 1px solid #eee;
        padding: 24px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      main {
        flex: 1;
        padding: 24px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      h1 {
        margin: 0;
        font-size: 20px;
      }

      label {
        font-size: 12px;
        text-transform: uppercase;
        color: #475467;
        letter-spacing: 0.08em;
      }

      select,
      textarea,
      button {
        width: 100%;
        box-sizing: border-box;
        font-size: 14px;
      }

      select,
      textarea {
        border: 1px solid #d0d5dd;
        border-radius: 6px;
        padding: 8px;
      }

      textarea {
        min-height: 200px;
        font-family: ui-monospace, "SFMono-Regular", SFMono, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      button {
        background: #0f62fe;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      button.secondary {
        background: #e4e7ec;
        color: #101828;
      }

      .status {
        font-size: 12px;
        color: #475467;
        min-height: 20px;
      }

      .grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid #eaecf0;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card h3 {
        margin: 0;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
        text-transform: uppercase;
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
        color: #475467;
      }

      pre {
        background: #f8fafc;
        border-radius: 6px;
        padding: 12px;
        overflow-x: auto;
        font-size: 12px;
        max-height: 320px;
      }

      ul {
        margin: 0;
        padding-left: 20px;
        font-size: 12px;
        color: #b54708;
      }

      #irOutput {
        max-height: 240px;
      }
    </style>
  </head>
  <body>
    <aside>
      <h1>Dev Viewer</h1>
      <div>
        <label for="fixtureSelect">Fixture</label>
        <select id="fixtureSelect"></select>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="loadFixture">Load Fixture</button>
        <button id="renderCard" class="secondary">Render</button>
      </div>
      <div>
        <label for="providerSelect">Provider</label>
        <select id="providerSelect"></select>
      </div>
      <div>
        <label for="cardInput">MessageCard JSON</label>
        <textarea id="cardInput" spellcheck="false"></textarea>
      </div>
      <div>
        <label for="operatorTenant">Tenant</label>
        <input id="operatorTenant" type="text" value="demo" />
      </div>
      <div>
        <label for="operatorTeam">Team</label>
        <input id="operatorTeam" type="text" value="default" />
      </div>
      <div>
        <label for="operatorText">Text (optional)</label>
        <input id="operatorText" type="text" placeholder="free-form text" />
      </div>
      <div style="display:flex; align-items:center; gap:6px; font-size:12px;">
        <input type="checkbox" id="providerPlatformFilter" checked />
        <label for="providerPlatformFilter">Only show platforms for selected provider</label>
      </div>
      <div style="display:flex; align-items:center; gap:6px; font-size:12px;">
        <input type="checkbox" id="dryRunToggle" />
        <label for="dryRunToggle">Dry run (show command only)</label>
      </div>
      <div class="status" id="providerStatus"></div>
      <div class="status" id="providerDetails"></div>
      <div class="status" id="providerSummary"></div>
      <div class="status" id="providerErrors"></div>
      <div class="status" id="status"></div>
    </aside>
    <main>
      <section>
        <h2>Normalized IR</h2>
        <pre id="irOutput"></pre>
      </section>
      <section>
        <h2 id="previewHeading">Platform Preview</h2>
        <div class="grid" id="platformGrid"></div>
      </section>
    </main>
    <script>
      const fixtureSelect = document.getElementById('fixtureSelect');
      const loadFixtureBtn = document.getElementById('loadFixture');
      const renderBtn = document.getElementById('renderCard');
      const cardInput = document.getElementById('cardInput');
      const statusEl = document.getElementById('status');
      const irOutput = document.getElementById('irOutput');
      const platformGrid = document.getElementById('platformGrid');
      const previewHeading = document.getElementById('previewHeading');
      const providerSelect = document.getElementById('providerSelect');
      const providerStatus = document.getElementById('providerStatus');
      const providerDetails = document.getElementById('providerDetails');
      const providerSummary = document.getElementById('providerSummary');
      const providerErrors = document.getElementById('providerErrors');
      const operatorTenant = document.getElementById('operatorTenant');
      const operatorTeam = document.getElementById('operatorTeam');
      const operatorText = document.getElementById('operatorText');
      const dryRunToggle = document.getElementById('dryRunToggle');
      const providerPlatformFilter = document.getElementById('providerPlatformFilter');

      let debounceHandle = null;
      let fixtures = [];
      let providers = [];
      let platformPreviews = [];
      let sendResults = new Map();
      let sendInProgress = new Set();
      let isDevMode = false;
      providerSelect.disabled = true;
      providerStatus.textContent = 'Providers not loaded';
      providerDetails.textContent = 'Provide `--provider-pack` or `--packs-dir` to load providers';
      providerSummary.style.display = 'none';

      async function bootstrap() {
        try {
          fixtures = await fetchJSON('/fixtures');
          fixtureSelect.replaceChildren(
            ...fixtures.map((name) => {
              const opt = document.createElement('option');
              opt.value = name;
              opt.textContent = name;
              return opt;
            }),
          );
          if (fixtures.length) {
            await loadFixture(fixtures[0]);
          }
          await loadProviders();
        } catch (err) {
          statusEl.textContent = err.message || err;
        }
      }

      async function loadProviders() {
        providerStatus.textContent = 'Loading providers…';
        providerSummary.textContent = '';
        providerErrors.textContent = '';
        providerSelect.disabled = true;
        try {
          const data = await fetchJSON('/providers');
          isDevMode = data.dev_mode;
          if (isDevMode) {
            console.log('dev-viewer running in dev mode');
          }
          providers = data.providers;
        providerSelect.replaceChildren(
          ...providers.map((provider) => {
            const opt = document.createElement('option');
              opt.value = provider.id;
              opt.textContent = `${provider.id} (${provider.pack_path})`;
              return opt;
            }),
          );
          if (isDevMode) {
            providerSummary.style.display = '';
            renderProviderSummary(data.summary, providers.length);
          } else {
            providerSummary.style.display = 'none';
            providerSummary.textContent = '';
          }
          renderProviderErrors(data.summary);
          if (providers.length > 0) {
            providerSelect.disabled = false;
            const initial = providers[0];
            providerStatus.textContent = `Selected provider ${initial.id}`;
            renderProviderDetails(initial);
            providerSelect.value = initial.id;
            updatePreviewHeading(initial);
          } else {
            providerDetails.textContent = data.summary.strict_mode
              ? 'Provider packs were requested but no providers could be loaded'
              : 'Use --provider-pack/--packs-dir to load providers';
            providerStatus.textContent = data.summary.strict_mode
              ? 'No providers available from requested packs'
              : 'Providers not configured';
            updatePreviewHeading(null);
          }
        } catch (err) {
          providerStatus.textContent = err.message || err;
          providerDetails.textContent = 'Unable to load providers';
          providerSummary.textContent = '';
          providerErrors.textContent = '';
        }
      }

      function renderProviderSummary(summary, providerCount) {
        providerSummary.replaceChildren();
        const base = document.createElement('div');
        base.textContent = describeSummary(summary, providerCount);
        providerSummary.appendChild(base);
        if (summary.requested_packs.length) {
          const requested = document.createElement('div');
          requested.textContent = `Requested packs: ${summary.requested_packs.join(', ')}`;
          providerSummary.appendChild(requested);
        }
        if (summary.searched_dirs.length) {
          const searched = document.createElement('div');
          searched.textContent = `Searched directories: ${summary.searched_dirs.join(', ')}`;
          providerSummary.appendChild(searched);
        }
      }

      function describeSummary(summary, providerCount) {
        if (summary.pack_count > 0) {
          return `Loaded ${providerCount} provider(s) from ${summary.pack_count} pack(s).`;
        }
        if (summary.strict_mode) {
          return 'Provider packs were requested but no providers were available.';
        }
        return 'Provider packs not configured; supply --provider-pack or --packs-dir.';
      }

      function renderProviderErrors(summary) {
        providerErrors.replaceChildren();
        let emitted = false;
        if (summary.errors.length) {
          emitted = true;
          const title = document.createElement('div');
          title.textContent = 'Pack load errors:';
          providerErrors.appendChild(title);
          const list = document.createElement('ul');
          summary.errors.forEach((error) => {
            const li = document.createElement('li');
            li.textContent = `${error.path}: ${error.reason}`;
            list.appendChild(li);
          });
          providerErrors.appendChild(list);
        }
        if (summary.platform_errors.length) {
          emitted = true;
          const title = document.createElement('div');
          title.textContent = 'Platform discovery warnings:';
          providerErrors.appendChild(title);
          const list = document.createElement('ul');
          summary.platform_errors.forEach((error) => {
            const li = document.createElement('li');
            li.textContent = error;
            list.appendChild(li);
          });
          providerErrors.appendChild(list);
        }
        if (!emitted) {
          providerErrors.textContent = '';
        }
      }

      function renderProviderDetails(provider) {
        if (!provider) {
          providerDetails.textContent = 'No provider selected';
          return;
        }
        providerDetails.innerHTML = `
          <div><strong>Provider ID:</strong> ${provider.id}</div>
          <div><strong>Provider Type:</strong> ${provider.provider_type}</div>
          <div><strong>Pack ID:</strong> ${provider.pack_id}</div>
          <div><strong>Pack:</strong> ${provider.pack_path}</div>
          <div><strong>Pack Root:</strong> ${provider.pack_root}</div>
          <div><strong>Runtime:</strong> ${provider.runtime.component_ref} (${provider.runtime.world})</div>
          <div><strong>Capabilities:</strong> ${formatCapabilities(provider.capabilities)}</div>
        `;
      }

      function formatCapabilities(capabilities) {
        if (!capabilities || !capabilities.length) {
          return 'none';
        }
        return capabilities.join(' | ');
      }

      function formatProviderDisplayName(id) {
        if (!id) {
          return 'Platform';
        }
        const token = id.split('.').pop() || id;
        return token
          .split(/[^a-zA-Z0-9]+/)
          .filter((segment) => segment.length)
          .map((segment) => segment[0].toUpperCase() + segment.slice(1))
          .join(' ');
      }

      function updatePreviewHeading(provider) {
        previewHeading.textContent = provider
          ? `${formatProviderDisplayName(provider.id)} Preview`
          : 'Platform Preview';
      }

      async function loadFixture(name) {
        try {
          const data = await fetchJSON(`/fixtures/${name}`);
          cardInput.value = JSON.stringify(data, null, 2);
          triggerRender();
        } catch (err) {
          statusEl.textContent = err.message || err;
        }
      }

      function triggerRender() {
        clearTimeout(debounceHandle);
        debounceHandle = setTimeout(renderCard, 350);
      }

      async function renderCard() {
        try {
          const payload = JSON.parse(cardInput.value);
          statusEl.textContent = 'Rendering…';
          const requestBody = { card: payload };
          if (!providerSelect.disabled && providerSelect.value) {
            requestBody.provider_id = providerSelect.value;
          }
          const data = await fetchJSON('/render', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
          });
          const specPayload =
            data.intent === 'auth' ? data.auth : data.ir;
          irOutput.textContent = specPayload
            ? JSON.stringify(specPayload, null, 2)
            : '// spec unavailable';
          platformPreviews = data.platforms;
          renderPlatforms();
          statusEl.textContent = 'Rendered';
          if (data.selected_provider) {
            providerStatus.textContent = `Using provider ${data.selected_provider.provider_id}`;
            const matched = providers.find(
              (candidate) => candidate.id === data.selected_provider.provider_id
            );
            updatePreviewHeading(matched);
          }
        } catch (err) {
          statusEl.textContent = err.message || err;
        }
      }

      function renderPlatforms() {
        platformGrid.replaceChildren();
        if (!platformPreviews.length) {
          const notice = document.createElement('div');
          notice.textContent =
            'No platform previews configured; load provider packs to enable platform conversions.';
          platformGrid.appendChild(notice);
          return;
        }

        const filterByProvider =
          providerPlatformFilter.checked && !providerSelect.disabled && providerSelect.value;
        let rendered = 0;
        platformPreviews.forEach((entry) => {
          if (filterByProvider && entry.descriptor.provider_id !== providerSelect.value) {
            return;
          }
          rendered += 1;

          const card = document.createElement('div');
          card.className = 'card';

          const header = document.createElement('h3');
          header.textContent = entry.descriptor.label;

          const platformBadge = document.createElement('span');
          platformBadge.className = 'badge';
          platformBadge.textContent = entry.descriptor.platform_key;
          header.appendChild(platformBadge);

          card.appendChild(header);

          const info = document.createElement('div');
          info.className = 'meta';
          info.appendChild(createMetaSpan('Provider', entry.descriptor.provider_id));
          info.appendChild(createMetaSpan('Pack ID', entry.descriptor.pack_id));
          info.appendChild(createMetaSpan('Pack', entry.descriptor.pack_path));
          info.appendChild(
            createMetaSpan(
              'Runtime',
              `${entry.descriptor.runtime_component} (${entry.descriptor.runtime_world})`
            )
          );
          info.appendChild(
            createMetaSpan('Capabilities', formatCapabilities(entry.descriptor.capabilities))
          );
          card.appendChild(info);
          const sendSection = document.createElement('div');
          sendSection.className = 'meta';
          const sendButton = document.createElement('button');
          const sending = sendInProgress.has(entry.descriptor.id);
          sendButton.textContent = sending ? 'Sending…' : 'Send Test';
          sendButton.disabled = sending || !entry.preview;
          sendButton.addEventListener('click', () => {
            sendTest(entry);
          });
          sendSection.appendChild(sendButton);
          const statusLine = document.createElement('span');
          const cached = sendResults.get(entry.descriptor.id);
          if (cached) {
            statusLine.textContent = formatSendStatus(cached);
          }
          sendSection.appendChild(statusLine);
          card.appendChild(sendSection);
          if (cached) {
            const log = document.createElement('pre');
            log.textContent = formatSendLogs(cached);
            card.appendChild(log);
          }

          if (entry.error) {
            const error = document.createElement('div');
            error.textContent = entry.error;
            error.style.color = '#b54708';
            card.appendChild(error);
          } else if (entry.preview) {
            const meta = document.createElement('div');
            meta.className = 'meta';
            [
              ['tier', entry.preview.tier],
              ['target', entry.preview.target_tier],
              ['warnings', entry.preview.warnings.length],
              ['limit', entry.preview.limit_exceeded],
              ['modal', entry.preview.used_modal],
              ['sanitized', entry.preview.sanitized_count],
              ['urls blocked', entry.preview.url_blocked_count],
            ].forEach(([label, value]) => {
              const span = document.createElement('span');
              span.textContent = `${label}: ${value}`;
              meta.appendChild(span);
            });

            const warningsList = document.createElement('ul');
            (entry.preview.warnings || []).forEach((warning) => {
              const li = document.createElement('li');
              li.textContent = warning;
              warningsList.appendChild(li);
            });

            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(entry.preview.payload, null, 2);

            card.appendChild(meta);
            if (warningsList.childElementCount > 0) {
              card.appendChild(warningsList);
            }
            card.appendChild(pre);
          }

          platformGrid.appendChild(card);
        });

        if (rendered === 0) {
      const notice = document.createElement('div');
      notice.textContent = filterByProvider
        ? 'No platform previews are available for the selected provider.'
        : 'No platform previews are available.';
      platformGrid.appendChild(notice);
    }
  }

      async function sendTest(entry) {
        if (!entry.preview) {
          return;
        }
          const requestBody = {
            provider_id: entry.descriptor.provider_id,
            provider_type: entry.descriptor.provider_type,
            pack_root: entry.descriptor.pack_root,
            tenant: operatorTenant.value || 'demo',
            team: operatorTeam.value || 'default',
            text: operatorText.value || null,
            payload: JSON.stringify(entry.preview.payload),
            dry_run: dryRunToggle.checked,
          extra_args: [],
        };
        sendInProgress.add(entry.descriptor.id);
        renderPlatforms();
        try {
          const result = await fetchJSON('/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
          });
          sendResults.set(entry.descriptor.id, result);
        } catch (err) {
          sendResults.set(entry.descriptor.id, {
            ok: false,
            exit_code: null,
            stdout: '',
            stderr: err.message || err,
            command: [],
          });
        } finally {
          sendInProgress.delete(entry.descriptor.id);
          renderPlatforms();
        }
      }

      function formatSendStatus(result) {
        if (result.ok) {
          return `Sent ✓ (exit ${result.exit_code ?? 0})`;
        }
        const code = result.exit_code ?? 'unknown';
        return `Send failed (exit ${code})`;
      }

      function formatSendLogs(result) {
        const lines = [];
        if (result.command.length) {
          lines.push(`command: ${result.command.join(' ')}`);
        }
        if (result.stdout) {
          lines.push(`stdout:\n${result.stdout}`);
        }
        if (result.stderr) {
          lines.push(`stderr:\n${result.stderr}`);
        }
        return lines.join('\n\n');
      }

  function createMetaSpan(label, value) {
        const element = document.createElement('span');
        element.textContent = `${label}: ${value}`;
        return element;
      }

      async function fetchJSON(url, init) {
        const res = await fetch(url, init);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        return res.json();
      }

      loadFixtureBtn.addEventListener('click', () => {
        const name = fixtureSelect.value;
        if (name) {
          loadFixture(name);
        }
      });

      providerSelect.addEventListener('change', () => {
        const provider = providers.find((candidate) => candidate.id === providerSelect.value);
        renderProviderDetails(provider);
        providerStatus.textContent = provider
          ? `Selected provider ${provider.id}`
          : 'No provider selected';
        renderPlatforms();
        updatePreviewHeading(provider);
      });

      dryRunToggle.addEventListener('change', renderPlatforms);

      providerPlatformFilter.addEventListener('change', renderPlatforms);
      renderBtn.addEventListener('click', () => renderCard());
      cardInput.addEventListener('input', () => triggerRender());

      bootstrap();
    </script>
  </body>
</html>
