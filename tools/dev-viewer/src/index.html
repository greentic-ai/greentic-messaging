<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Greentic Dev Viewer</title>
    <style>
      :root {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #101828;
        background: #f5f5f5;
      }

      body {
        margin: 0;
        padding: 0;
        display: flex;
        min-height: 100vh;
      }

      aside {
        width: 320px;
        background: #ffffff;
        border-right: 1px solid #eee;
        padding: 24px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      main {
        flex: 1;
        padding: 24px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      h1 {
        margin: 0;
        font-size: 20px;
      }

      label {
        font-size: 12px;
        text-transform: uppercase;
        color: #475467;
        letter-spacing: 0.08em;
      }

      select,
      textarea,
      button {
        width: 100%;
        box-sizing: border-box;
        font-size: 14px;
      }

      select,
      textarea {
        border: 1px solid #d0d5dd;
        border-radius: 6px;
        padding: 8px;
      }

      textarea {
        min-height: 200px;
        font-family: ui-monospace, "SFMono-Regular", SFMono, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      button {
        background: #0f62fe;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      button.secondary {
        background: #e4e7ec;
        color: #101828;
      }

      .status {
        font-size: 12px;
        color: #475467;
        min-height: 20px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid #eaecf0;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card h3 {
        margin: 0;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
        text-transform: uppercase;
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
        color: #475467;
      }

      pre {
        background: #f8fafc;
        border-radius: 6px;
        padding: 12px;
        overflow-x: auto;
        font-size: 12px;
        max-height: 320px;
      }

      ul {
        margin: 0;
        padding-left: 20px;
        font-size: 12px;
        color: #b54708;
      }

      #irOutput {
        max-height: 240px;
      }
    </style>
  </head>
  <body>
    <aside>
      <h1>Dev Viewer</h1>
      <div>
        <label for="fixtureSelect">Fixture</label>
        <select id="fixtureSelect"></select>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="loadFixture">Load Fixture</button>
        <button id="renderCard" class="secondary">Render</button>
      </div>
      <div>
        <label for="providerSelect">Provider</label>
        <select id="providerSelect"></select>
      </div>
      <div class="status" id="providerStatus"></div>
      <div class="status" id="providerDetails"></div>
      <div>
        <label for="cardInput">MessageCard JSON</label>
        <textarea id="cardInput" spellcheck="false"></textarea>
      </div>
      <div class="status" id="status"></div>
    </aside>
    <main>
      <section>
        <h2>Normalized IR</h2>
        <pre id="irOutput"></pre>
      </section>
      <section>
        <h2>Platform Previews</h2>
        <div class="grid" id="platformGrid"></div>
      </section>
    </main>
    <script>
      const fixtureSelect = document.getElementById('fixtureSelect');
      const loadFixtureBtn = document.getElementById('loadFixture');
      const renderBtn = document.getElementById('renderCard');
      const cardInput = document.getElementById('cardInput');
      const statusEl = document.getElementById('status');
      const irOutput = document.getElementById('irOutput');
      const platformGrid = document.getElementById('platformGrid');
      const providerSelect = document.getElementById('providerSelect');
      const providerStatus = document.getElementById('providerStatus');
      const providerDetails = document.getElementById('providerDetails');

      let debounceHandle = null;
      let fixtures = [];
      let providers = [];
      providerSelect.disabled = true;
      providerStatus.textContent = 'Providers not loaded';
      providerDetails.textContent = 'Provide `--provider-pack` or `--packs-dir` to load providers';

      async function bootstrap() {
        try {
          fixtures = await fetchJSON('/fixtures');
          fixtureSelect.replaceChildren(
            ...fixtures.map((name) => {
              const opt = document.createElement('option');
              opt.value = name;
              opt.textContent = name;
              return opt;
            }),
          );
          if (fixtures.length) {
            await loadFixture(fixtures[0]);
          }
          await loadProviders();
        } catch (err) {
          statusEl.textContent = err.message || err;
        }
      }

      async function loadProviders() {
        providerStatus.textContent = 'Loading providers…';
        try {
          providers = await fetchJSON('/providers');
          providerSelect.replaceChildren(
            ...providers.map((provider) => {
              const opt = document.createElement('option');
              opt.value = provider.id;
              opt.textContent = `${provider.id} (${provider.pack_path})`;
              return opt;
            }),
          );
          if (providers.length > 0) {
            const initial = providers[0];
            providerStatus.textContent = `Selected provider ${initial.id}`;
            providerSelect.disabled = false;
            renderProviderDetails(providers[0]);
            providerSelect.value = providers[0].id;
          } else {
            providerStatus.textContent = 'No providers loaded from packs';
            providerSelect.disabled = true;
            providerDetails.textContent = 'Use --provider-pack/--packs-dir to load providers';
          }
        } catch (err) {
          providerStatus.textContent = err.message || err;
          providerSelect.disabled = true;
          providerDetails.textContent = 'Unable to load providers';
        }
      }

      function renderProviderDetails(provider) {
        if (!provider) {
          providerDetails.textContent = 'No provider selected';
          return;
        }
        providerDetails.innerHTML = `
          <div><strong>Provider ID:</strong> ${provider.id}</div>
          <div><strong>Pack:</strong> ${provider.pack_path}</div>
          <div><strong>Pack Root:</strong> ${provider.pack_root}</div>
          <div><strong>Runtime:</strong> ${provider.runtime.component_ref} (${provider.runtime.world})</div>
          <div><strong>Capabilities:</strong> ${formatCapabilities(provider.capabilities)}</div>
        `;
      }

      function formatCapabilities(capabilities) {
        const parts = [];
        if (capabilities.supports_webhook_validation) {
          parts.push('webhook-validation');
        }
        if (capabilities.content_types && capabilities.content_types.length) {
          parts.push(`content-types: ${capabilities.content_types.join(', ')}`);
        }
        return parts.join(' | ') || 'none';
      }

      async function loadFixture(name) {
        try {
          const data = await fetchJSON(`/fixtures/${name}`);
          cardInput.value = JSON.stringify(data, null, 2);
          triggerRender();
        } catch (err) {
          statusEl.textContent = err.message || err;
        }
      }

      function triggerRender() {
        clearTimeout(debounceHandle);
        debounceHandle = setTimeout(renderCard, 350);
      }

      async function renderCard() {
        try {
          const payload = JSON.parse(cardInput.value);
          statusEl.textContent = 'Rendering…';
          const requestBody = { card: payload };
          if (!providerSelect.disabled && providerSelect.value) {
            requestBody.provider_id = providerSelect.value;
          }
          const data = await fetchJSON('/render', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
          });
          const specPayload =
            data.intent === 'auth' ? data.auth : data.ir;
          irOutput.textContent = specPayload
            ? JSON.stringify(specPayload, null, 2)
            : '// spec unavailable';
          renderPlatforms(data.platforms);
          statusEl.textContent = 'Rendered';
          if (data.selected_provider) {
            providerStatus.textContent = `Using provider ${data.selected_provider.provider_id}`;
          }
        } catch (err) {
          statusEl.textContent = err.message || err;
        }
      }

      function renderPlatforms(map) {
        platformGrid.replaceChildren();
        Object.entries(map).forEach(([name, details]) => {
          const card = document.createElement('div');
          card.className = 'card';

          const header = document.createElement('h3');
          header.textContent = name;
          const tierBadge = document.createElement('span');
          tierBadge.className = 'badge';
          tierBadge.textContent = details.tier;
          header.appendChild(tierBadge);
          if (details.downgraded) {
            const downgraded = document.createElement('span');
            downgraded.className = 'badge';
            downgraded.style.background = '#fef3c7';
            downgraded.style.color = '#92400e';
            downgraded.textContent = 'DOWNGRADED';
            header.appendChild(downgraded);
          }

          const meta = document.createElement('div');
          meta.className = 'meta';
          [
            ['target', details.target_tier],
            ['modal', details.used_modal],
            ['warnings', details.warnings.length],
            ['limit', details.limit_exceeded],
            ['sanitized', details.sanitized_count],
            ['urls blocked', details.url_blocked_count],
          ].forEach(([label, value]) => {
            const span = document.createElement('span');
            span.textContent = `${label}: ${value}`;
            meta.appendChild(span);
          });

          const warningsList = document.createElement('ul');
          (details.warnings || []).forEach((w) => {
            const li = document.createElement('li');
            li.textContent = w;
            warningsList.appendChild(li);
          });

          const pre = document.createElement('pre');
          pre.textContent = JSON.stringify(details.payload, null, 2);

          card.appendChild(header);
          card.appendChild(meta);
          if (warningsList.childElementCount > 0) {
            card.appendChild(warningsList);
          }
          card.appendChild(pre);
          platformGrid.appendChild(card);
        });
      }

      async function fetchJSON(url, init) {
        const res = await fetch(url, init);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        return res.json();
      }

      loadFixtureBtn.addEventListener('click', () => {
        const name = fixtureSelect.value;
        if (name) {
          loadFixture(name);
        }
      });

      providerSelect.addEventListener('change', () => {
        const provider = providers.find((candidate) => candidate.id === providerSelect.value);
        renderProviderDetails(provider);
        providerStatus.textContent = provider
          ? `Selected provider ${provider.id}`
          : 'No provider selected';
      });

      renderBtn.addEventListener('click', () => renderCard());
      cardInput.addEventListener('input', () => triggerRender());

      bootstrap();
    </script>
  </body>
</html>
