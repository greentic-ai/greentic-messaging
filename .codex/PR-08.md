---
id: PR-08
track: host
depends_on: [PR-06, PR-07]
---
# PR-08: Wire planner + provider registry behind a feature flag (no default behavior change)

## Goal
Connect the new render planner and provider registry into the host execution path **without changing default runtime behavior**, enabling safe, incremental rollout.

This PR creates the bridge from:
- canonical message → RenderPlan → provider encoder

…but keeps the legacy path as the default.

## Changes
- Introduce `RenderMode` enum:
  - `Legacy`
  - `Planned`
- Add config flag:
  - `messaging.render_mode = legacy | planned`
- In egress pipeline:
  - If `legacy`: keep existing behavior untouched
  - If `planned`:
    1) Load provider capabilities from `ProviderRegistry`
    2) Run `plan_render(...)`
    3) Pass `RenderPlan` to provider encoder
- Add structured telemetry:
  - render tier selected
  - downgrade reasons
  - warning count

## Suggested locations
- `crates/greentic-messaging-core/src/render/mod.rs`
- `crates/greentic-messaging-core/src/egress/send.rs`
- `crates/greentic-messaging-core/src/config/render.rs`

## Acceptance criteria
- Default behavior remains **legacy**
- Planned mode can be enabled via config in dev/tests
- No provider-specific branching added
- Unit tests cover:
  - legacy path unchanged
  - planned path produces a `RenderPlan` and calls encoder
- CI stays green

## Notes
- This PR is the **cut point**: after this, provider-side PRs can start landing safely.
- Do not remove legacy rendering yet; that happens only after parity is proven.
